<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      
      <!-- Si NO tiene Be Pass, muestra el formulario de creación -->
      <div *ngIf="!hasBePass">
        <!-- Formulario para Clave Be Pass (creación) -->
        <div class="card shadow-sm mb-5">
          <div class="card-body">
            <h2 class="card-title">{{ 'security.bePassSetup' | translate }}</h2>
            <p class="card-subtitle mb-4 text-muted">{{ 'security.bePassDescription' | translate }}</p>

            <div *ngIf="message" class="alert alert-success mt-3">{{ message }}</div>
            <div *ngIf="error" class="alert alert-danger mt-3">{{ error }}</div>

            <form (ngSubmit)="onSubmit()" #bepassForm="ngForm">
              <div class="form-group">
                <label for="newBepass">{{ 'security.createNewBePass' | translate }}</label>
                <input type="password" id="newBepass" name="newBepass" class="form-control" 
                       [(ngModel)]="bepassData.newBepass" required minlength="6" maxlength="6" 
                       pattern="[0-9]{6}" inputmode="numeric" (input)="onBepassInput($event)">
                <small class="form-text text-muted">{{ 'security.bePassHint' | translate }}</small>
              </div>

              <div class="form-group">
                <label for="confirmBepass">{{ 'security.confirmNewBePass' | translate }}</label>
                <input type="password" id="confirmBepass" name="confirmBepass" class="form-control" 
                       [(ngModel)]="bepassData.confirmBepass" required (input)="onBepassInput($event)" maxlength="6">
              </div>

              <hr class="my-4">

              <div class="form-group">
                <label for="currentPassword">{{ 'security.currentPassword' | translate }}</label>
                <input type="password" id="currentPassword" name="currentPassword" class="form-control" 
                       [(ngModel)]="bepassData.currentPassword" required>
                <small class="form-text text-muted">{{ 'security.currentPasswordHint' | translate }}</small>
              </div>

              <button type="submit" class="btn btn-primary btn-block mt-4" [disabled]="!bepassForm.form.valid">{{ 'security.setBePass' | translate }}</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Si tiene Be Pass y NO ha pasado 2FA, muestra el flujo de 2FA -->
      <div *ngIf="hasBePass && !is2FAVerified">
        <div class="card shadow-sm mb-5">
          <div class="card-body">
            <h2 class="card-title">{{ 'security.twoFactorVerification' | translate }}</h2>
            <p class="card-subtitle mb-4 text-muted">{{ 'security.twoFactorDescription' | translate }}</p>
            <app-google-2fa (verified)="on2FAVerified($event)"></app-google-2fa>
          </div>
        </div>
      </div>

      <!-- Si tiene Be Pass y ya pasó 2FA, muestra el formulario de cambio -->
      <div *ngIf="hasBePass && is2FAVerified">
        <div class="card shadow-sm mb-5">
          <div class="card-body">
            <h2 class="card-title">{{ 'security.changeBePass' | translate }}</h2>
            <form (ngSubmit)="onChangeBepassSubmit()" #changeBepassForm="ngForm">
              <div class="form-group">
                <label for="changeNewBepass">{{ 'security.newBePass' | translate }}</label>
                <input type="password" id="changeNewBepass" name="newBepass" class="form-control"
                       [(ngModel)]="changeBepassData.newBepass" required minlength="6" maxlength="6"
                       pattern="[0-9]{6}" inputmode="numeric" (input)="onChangeBepassInput($event)">
                <small class="form-text text-muted">{{ 'security.bePassHint' | translate }}</small>
              </div>
              <div class="form-group">
                <label for="changeConfirmBepass">{{ 'security.confirmNewBePass' | translate }}</label>
                <input type="password" id="changeConfirmBepass" name="confirmBepass" class="form-control"
                       [(ngModel)]="changeBepassData.confirmBepass" required (input)="onChangeBepassInput($event)" maxlength="6">
              </div>
              <hr class="my-4">
              <div class="form-group">
                <label for="changeCurrentPassword">{{ 'security.currentPassword' | translate }}</label>
                <input type="password" id="changeCurrentPassword" name="currentPassword" class="form-control"
                       [(ngModel)]="changeBepassData.currentPassword" required>
                <small class="form-text text-muted">{{ 'security.currentPasswordHint' | translate }}</small>
              </div>
              <div *ngIf="changeMessage" class="alert alert-success mt-3">{{ changeMessage }}</div>
              <div *ngIf="changeError" class="alert alert-danger mt-3">{{ changeError }}</div>
              <button type="submit" class="btn btn-primary btn-block mt-4" [disabled]="!changeBepassForm.form.valid">{{ 'security.changeBePass' | translate }}</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Apartado de recuperación de contraseña -->
      <div class="d-flex flex-column align-items-center w-100">
        <div class="card shadow-sm mb-5 security-card">
          <div class="card-body">
            <div class="d-flex flex-column align-items-center w-100">
              <div class="recover-password-form w-100 compact-recover-form">
                <h2 class="card-title">{{ 'security.recoverPassword' | translate }}</h2>
                <p class="card-subtitle mb-4 text-muted">{{ 'security.recoverDescription' | translate }}</p>
                <form (ngSubmit)="onRecoverPasswordSubmit()">
                  <div class="mb-2">
                    <label for="recoverEmail" class="form-label">{{ 'common.email' | translate }}</label>
                    <input type="email" id="recoverEmail" name="recoverEmail" class="form-control" [(ngModel)]="recoverEmail" [readonly]="true" required>
                  </div>
                  <div *ngIf="recoverMessage" class="alert alert-success mt-2">{{ recoverMessage }}</div>
                  <div *ngIf="recoverError" class="alert alert-danger mt-2">{{ recoverError }}</div>
                  <div class="d-grid mt-2">
                    <button type="submit" class="btn btn-primary btn-lg">{{ 'security.sendEmail' | translate }}</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Consejos de Seguridad -->
      <div class="security-advice-container">
        <h1>{{ 'security.securityTips' | translate }}</h1>
        <p class="subtitle">{{ 'security.securitySubtitle' | translate }}</p>
        <div class="advice-list">
          <div class="advice-item">
            <i class="fas fa-shield-alt"></i>
            <h3>{{ 'security.tips.verifyUrl.title' | translate }}</h3>
            <p>{{ 'security.tips.verifyUrl.description' | translate }}</p>
          </div>
          <div class="advice-item">
            <i class="fas fa-user-lock"></i>
            <h3>{{ 'security.tips.dontSharePassword.title' | translate }}</h3>
            <p>{{ 'security.tips.dontSharePassword.description' | translate }}</p>
          </div>
          <div class="advice-item">
            <i class="fas fa-envelope-open-text"></i>
            <h3>{{ 'security.tips.carefulWithEmails.title' | translate }}</h3>
            <p>{{ 'security.tips.carefulWithEmails.description' | translate }}</p>
          </div>
          <div class="advice-item">
            <i class="fas fa-search-dollar"></i>
            <h3>{{ 'security.tips.verifyBeforeSending.title' | translate }}</h3>
            <p>{{ 'security.tips.verifyBeforeSending.description' | translate }}</p>
          </div>
          <div class="advice-item">
            <i class="fas fa-sync-alt"></i>
            <h3>{{ 'security.tips.updatePasswords.title' | translate }}</h3>
            <p>{{ 'security.tips.updatePasswords.description' | translate }}</p>
          </div>
        </div>
      </div>

      <!-- Modal/Sección QR 2FA -->
      <div *ngIf="show2FAQr" class="modal-backdrop show"></div>
      <div *ngIf="show2FAQr" class="modal d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{ 'security.googleAuthenticator.title' | translate }}</h5>
              <button type="button" class="btn-close" [attr.aria-label]="'Cerrar'" (click)="close2FAQr()"></button>
            </div>
            <div class="modal-body text-center">
              <p>{{ 'security.googleAuthenticator.description' | translate }}</p>
              <img [src]="qrData" alt="QR 2FA" />
              <p class="mt-3"><strong>{{ 'security.googleAuthenticator.scanned' | translate }}</strong></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" (click)="close2FAQr()">{{ 'security.googleAuthenticator.ready' | translate }}</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
